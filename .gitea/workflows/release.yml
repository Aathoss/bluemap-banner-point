name: Release - Build et Package
run-name: Release - Build et Package

on:
  push:
    tags:
      - "v*"
      - "release-*"

env:
  PROJECT_NAME: bluemap-banner-point
  JAVA_VERSION: 21

jobs:
  # Job de notification de d√©but de release
  notify-release-start:
    runs-on: ubuntu-latest
    steps:
      - name: Extraction de la version
        id: version
        run: |
          echo "üîç Extraction de la version..."
          echo "GITEA_REF: $GITEA_REF"
          echo "GITEA_REF_NAME: $GITEA_REF_NAME"

          # M√©thode 1: Extraire la version du tag
          VERSION=${GITEA_REF#refs/tags/}
          VERSION=${VERSION#v}
          VERSION=${VERSION#release-}

          # Si la version est vide, essayer avec GITEA_REF_NAME
          if [ -z "$VERSION" ]; then
            echo "‚ö†Ô∏è Version vide depuis GITEA_REF, essai avec GITEA_REF_NAME..."
            VERSION=${GITEA_REF_NAME#v}
            VERSION=${VERSION#release-}
          fi

          # Si toujours vide, extraire depuis pom.xml
          if [ -z "$VERSION" ]; then
            echo "‚ö†Ô∏è Version toujours vide, extraction depuis pom.xml..."
            VERSION=$(grep -o '<version>[^<]*</version>' pom.xml | head -1 | sed 's/<version>\(.*\)<\/version>/\1/')
          fi

          echo "üìã Version extraite: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION"

      - name: Notification de d√©but de release
        run: |
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üöÄ D√©but de la release",
                "description": "**Projet:** ${{ env.PROJECT_NAME }}\n**Version:** ${{ steps.version.outputs.version }}\n**Tag:** ${{ gitea.ref_name }}\n**Auteur:** ${{ gitea.actor }}",
                "color": 15844367,
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }'
          fi

  # Job principal de build et packaging
  build-release:
    runs-on: ubuntu-latest
    needs: notify-release-start
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Extraction de la version
        id: version
        run: |
          echo "üîç Extraction de la version..."
          echo "GITEA_REF: $GITEA_REF"
          echo "GITEA_REF_NAME: $GITEA_REF_NAME"

          # M√©thode 1: Extraire la version du tag
          VERSION=${GITEA_REF#refs/tags/}
          VERSION=${VERSION#v}
          VERSION=${VERSION#release-}

          # Si la version est vide, essayer avec GITEA_REF_NAME
          if [ -z "$VERSION" ]; then
            echo "‚ö†Ô∏è Version vide depuis GITEA_REF, essai avec GITEA_REF_NAME..."
            VERSION=${GITEA_REF_NAME#v}
            VERSION=${VERSION#release-}
          fi

          # Si toujours vide, extraire depuis pom.xml
          if [ -z "$VERSION" ]; then
            echo "‚ö†Ô∏è Version toujours vide, extraction depuis pom.xml..."
            VERSION=$(grep -o '<version>[^<]*</version>' pom.xml | head -1 | sed 's/<version>\(.*\)<\/version>/\1/')
          fi

          echo "üìã Version extraite: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION"

      - name: Installation de Java ${{ env.JAVA_VERSION }}
        run: |
          echo "üîß Installation de Java ${{ env.JAVA_VERSION }}..."
          sudo apt-get update
          sudo apt-get install -y openjdk-${{ env.JAVA_VERSION }}-jdk
          java -version
          echo "‚úÖ Java install√©"

      - name: Installation de Maven
        run: |
          echo "üì¶ Installation de Maven..."
          sudo apt-get install -y maven
          mvn -version
          echo "‚úÖ Maven install√©"

      - name: V√©rification des traductions
        run: |
          echo "üîç V√©rification des cl√©s de traduction..."
          python3 check_translations.py
          if [ $? -ne 0 ]; then
            echo "‚ùå Erreur dans les traductions"
            exit 1
          fi
          echo "‚úÖ Traductions OK"

      - name: Build du package final
        run: |
          echo "üì¶ Build du package final..."
          mvn clean package -DskipTests
          if [ $? -ne 0 ]; then
            echo "‚ùå Erreur de build"
            exit 1
          fi
          echo "‚úÖ Build r√©ussi"

      - name: Cr√©ation du lien latest
        run: |
          echo "üè∑Ô∏è Cr√©ation du lien latest..."
          echo "üìã Version extraite: ${{ steps.version.outputs.version }}"
          echo "üìã Nom du projet: ${{ env.PROJECT_NAME }}"

          cd target
          # Trouver le JAR avec version g√©n√©r√© par Maven
          JAR_FILE="${{ env.PROJECT_NAME }}-${{ steps.version.outputs.version }}.jar"
          echo "üîç Recherche du fichier: $JAR_FILE"

          if [ ! -f "$JAR_FILE" ]; then
            echo "‚ùå Fichier JAR $JAR_FILE non trouv√©"
            echo "üìÅ Contenu du dossier target:"
            ls -la *.jar
            echo "üîç Tentative de recherche alternative..."
            # Essayer de trouver le JAR avec un pattern plus large
            FOUND_JAR=$(ls -t *.jar | head -1)
            if [ -n "$FOUND_JAR" ]; then
              echo "‚úÖ JAR trouv√©: $FOUND_JAR"
              JAR_FILE="$FOUND_JAR"
            else
              echo "‚ùå Aucun JAR trouv√©"
              exit 1
            fi
          fi

          # Cr√©er une copie pour latest
          cp "$JAR_FILE" "${{ env.PROJECT_NAME }}-latest.jar"
          echo "‚úÖ Lien latest cr√©√©: ${{ env.PROJECT_NAME }}-latest.jar"

      - name: V√©rification du contenu du JAR
        run: |
          echo "üîç V√©rification du contenu du JAR..."
          cd target
          jar -tf "${{ env.PROJECT_NAME }}-${{ steps.version.outputs.version }}.jar" | head -20
          echo "‚úÖ Contenu du JAR v√©rifi√©"

      - name: Cr√©ation du checksum
        run: |
          echo "üîê Cr√©ation du checksum..."
          cd target
          sha256sum "${{ env.PROJECT_NAME }}-${{ steps.version.outputs.version }}.jar" > "${{ env.PROJECT_NAME }}-${{ steps.version.outputs.version }}.jar.sha256"
          echo "‚úÖ Checksum cr√©√©"

      - name: Upload des artefacts de release
        uses: actions/upload-artifact@v3
        with:
          name: release-artifacts
          path: |
            target/${{ env.PROJECT_NAME }}-${{ steps.version.outputs.version }}.jar
            target/${{ env.PROJECT_NAME }}-latest.jar
            target/${{ env.PROJECT_NAME }}-${{ steps.version.outputs.version }}.jar.sha256
          retention-days: 90

  # Job de notification de fin de release
  notify-release-end:
    runs-on: ubuntu-latest
    needs: build-release
    if: always()
    steps:
      - name: Extraction de la version
        id: version
        run: |
          VERSION=${GITEA_REF#refs/tags/}
          VERSION=${VERSION#v}
          VERSION=${VERSION#release-}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Notification de fin de release
        run: |
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            if [ "${{ needs.build-release.result }}" == "success" ]; then
              STATUS="‚úÖ Release r√©ussie"
              COLOR="3066993"
              EMOJI="üéâ"
              DESCRIPTION="**Projet:** ${{ env.PROJECT_NAME }}\n**Version:** ${{ steps.version.outputs.version }}\n**Tag:** ${{ gitea.ref_name }}\n**Auteur:** ${{ gitea.actor }}\n\nüì¶ Package JAR cr√©√© avec succ√®s"
            else
              STATUS="‚ùå Release √©chou√©e"
              COLOR="15158332"
              EMOJI="üí•"
              DESCRIPTION="**Projet:** ${{ env.PROJECT_NAME }}\n**Version:** ${{ steps.version.outputs.version }}\n**Tag:** ${{ gitea.ref_name }}\n**Auteur:** ${{ gitea.actor }}\n\n‚ùå Erreur lors de la cr√©ation du package"
            fi

            curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "'"$EMOJI $STATUS"'",
                "description": "'"$DESCRIPTION"'",
                "color": '"$COLOR"',
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }'
          fi
