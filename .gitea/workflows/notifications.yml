name: Notifications Discord
run-name: Notifications Discord

on:
  push:
    branches:
      - main
      - develop
      - dev
  pull_request:
    types: [opened, synchronize, reopened, closed]
  issues:
    types: [opened, closed, reopened]
  release:
    types: [published, edited, deleted]

env:
  PROJECT_NAME: bluemap-banner-point

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Notification d'√©v√©nement
        run: |
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            # D√©terminer le type d'√©v√©nement et les informations
            EVENT_TYPE="${{ gitea.event_name }}"

            # Fonction pour nettoyer les messages
            clean_message() {
              local msg="$1"
              if [ -z "$msg" ]; then
                echo "Aucun message"
              else
                echo "$msg" | sed 's/"/\\"/g' | head -c 100
              fi
            }

            case "$EVENT_TYPE" in
              "push")
                if [[ "${{ gitea.ref }}" == refs/tags/* ]]; then
                  TITLE="Nouveau tag cr√©√© : ${{ gitea.ref_name }}"
                  COLOR="15844367"
                  EMOJI="üè∑Ô∏è"
                  VERSION="${{ gitea.ref_name }}"
                  VERSION="${VERSION#v}"
                  VERSION="${VERSION#release-}"
                  DESCRIPTION="**Projet:** ${{ env.PROJECT_NAME }}\n**Tag:** ${{ gitea.ref_name }}\n**Version:** $VERSION\n**Auteur:** ${{ gitea.actor }}\n**Commit:** \`${{ gitea.sha }}\`"
                else
                  TITLE="Push sur la branche : ${{ gitea.ref_name }}"
                  COLOR="3447003"
                  EMOJI="üìù"
                  COMMIT_MSG=$(clean_message "${{ gitea.head_commit.message }}")
                  DESCRIPTION="**Projet:** ${{ env.PROJECT_NAME }}\n**Branche:** \`${{ gitea.ref_name }}\`\n**Auteur:** ${{ gitea.actor }}\n**Commit:** \`${{ gitea.sha }}\`\n**Message:** $COMMIT_MSG"
                fi
                ;;
              "pull_request")
                case "${{ gitea.event.action }}" in
                  "opened")
                    TITLE="Nouvelle Pull Request"
                    COLOR="3447003"
                    EMOJI="üîÄ"
                    ;;
                  "synchronize")
                    TITLE="Pull Request mise √† jour"
                    COLOR="15844367"
                    EMOJI="üîÑ"
                    ;;
                  "reopened")
                    TITLE="Pull Request r√©ouverte"
                    COLOR="15844367"
                    EMOJI="üîÑ"
                    ;;
                  "closed")
                    if [ "${{ gitea.event.pull_request.merged }}" == "true" ]; then
                      TITLE="Pull Request fusionn√©e"
                      COLOR="3066993"
                      EMOJI="‚úÖ"
                    else
                      TITLE="Pull Request ferm√©e"
                      COLOR="15158332"
                      EMOJI="‚ùå"
                    fi
                    ;;
                esac
                PR_TITLE=$(clean_message "${{ gitea.event.pull_request.title }}")
                DESCRIPTION="**Projet:** ${{ env.PROJECT_NAME }}\n**PR:** #${{ gitea.event.pull_request.number }} - $PR_TITLE\n**Auteur:** ${{ gitea.actor }}\n**Branche:** \`${{ gitea.event.pull_request.head.ref }}\` ‚Üí \`${{ gitea.event.pull_request.base.ref }}\`"
                ;;
              "issues")
                case "${{ gitea.event.action }}" in
                  "opened")
                    TITLE="Nouvelle issue"
                    COLOR="15158332"
                    EMOJI="üêõ"
                    ;;
                  "closed")
                    TITLE="Issue ferm√©e"
                    COLOR="3066993"
                    EMOJI="‚úÖ"
                    ;;
                  "reopened")
                    TITLE="Issue r√©ouverte"
                    COLOR="15844367"
                    EMOJI="üîÑ"
                    ;;
                esac
                ISSUE_TITLE=$(clean_message "${{ gitea.event.issue.title }}")
                ISSUE_LABELS="${{ join(gitea.event.issue.labels.*.name, ', ') }}"
                if [ -z "$ISSUE_LABELS" ]; then
                  ISSUE_LABELS="Aucun label"
                fi
                DESCRIPTION="**Projet:** ${{ env.PROJECT_NAME }}\n**Issue:** #${{ gitea.event.issue.number }} - $ISSUE_TITLE\n**Auteur:** ${{ gitea.actor }}\n**Labels:** $ISSUE_LABELS"
                ;;
              "release")
                case "${{ gitea.event.action }}" in
                  "published")
                    TITLE="Nouvelle release publi√©e"
                    COLOR="3066993"
                    EMOJI="üöÄ"
                    ;;
                  "edited")
                    TITLE="Release modifi√©e"
                    COLOR="15844367"
                    EMOJI="‚úèÔ∏è"
                    ;;
                  "deleted")
                    TITLE="Release supprim√©e"
                    COLOR="15158332"
                    EMOJI="üóëÔ∏è"
                    ;;
                esac
                RELEASE_NAME=$(clean_message "${{ gitea.event.release.name }}")
                DESCRIPTION="**Projet:** ${{ env.PROJECT_NAME }}\n**Release:** \`${{ gitea.event.release.tag_name }}\`\n**Titre:** $RELEASE_NAME\n**Auteur:** ${{ gitea.actor }}"
                ;;
              *)
                TITLE="√âv√©nement"
                COLOR="3447003"
                EMOJI="‚ÑπÔ∏è"
                DESCRIPTION="**Projet:** ${{ env.PROJECT_NAME }}\n**√âv√©nement:** $EVENT_TYPE\n**Auteur:** ${{ gitea.actor }}"
                ;;
            esac

            # Ajouter des champs suppl√©mentaires selon le contexte
            FIELDS=""
            if [ "$EVENT_TYPE" = "push" ] && [ "${{ gitea.ref }}" != refs/tags/* ]; then
              FIELDS=',"fields": [
                {
                  "name": "üîó Repository",
                  "value": "[Voir le commit](${{ gitea.server_url }}/${{ gitea.repository }}/commit/${{ gitea.sha }})",
                  "inline": true
                },
                {
                  "name": "üìä Branche",
                  "value": "[Voir la branche](${{ gitea.server_url }}/${{ gitea.repository }}/src/branch/${{ gitea.ref_name }})",
                  "inline": true
                }
              ]'
            elif [ "$EVENT_TYPE" = "pull_request" ]; then
              FIELDS=',"fields": [
                {
                  "name": "üîó Pull Request",
                  "value": "[Voir la PR](${{ gitea.server_url }}/${{ gitea.repository }}/pulls/${{ gitea.event.pull_request.number }})",
                  "inline": true
                }
              ]'
            elif [ "$EVENT_TYPE" = "issues" ]; then
              FIELDS=',"fields": [
                {
                  "name": "üîó Issue",
                  "value": "[Voir l'\''issue](${{ gitea.server_url }}/${{ gitea.repository }}/issues/${{ gitea.event.issue.number }})",
                  "inline": true
                }
              ]'
            fi

            curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "'"$EMOJI $TITLE "'",
                "description": "'"$DESCRIPTION"'",
                "color": '"$COLOR"',
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'",
                "footer": {
                  "text": "'"${{ env.PROJECT_NAME }}"'"
                }'"$FIELDS"'
              }]
            }'

            echo "‚úÖ Notification Discord envoy√©e pour l'√©v√©nement: $EVENT_TYPE"
          else
            echo "‚ö†Ô∏è Webhook Discord non configur√©, skip..."
          fi
