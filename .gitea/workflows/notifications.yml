name: Notifications Discord
run-name: Notifications Discord

on:
  push:
    branches:
      - main
      - develop
      - dev
  pull_request:
    types: [opened, synchronize, reopened, closed]
  issues:
    types: [opened, closed, reopened]
  release:
    types: [published, edited, deleted]

env:
  PROJECT_NAME: bluemap-banner-point

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Notification d'√©v√©nement
        run: |
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            # D√©terminer le type d'√©v√©nement et les informations
            EVENT_TYPE="${{ gitea.event_name }}"

            case "$EVENT_TYPE" in
              "push")
                if [[ "${{ gitea.ref }}" == refs/tags/* ]]; then
                  TITLE="üè∑Ô∏è Nouveau tag cr√©√©"
                  COLOR="15844367"
                  EMOJI="üè∑Ô∏è"
                  VERSION=${GITEA_REF#refs/tags/}
                  VERSION=${VERSION#v}
                  VERSION=${VERSION#release-}
                  DESCRIPTION="**Projet:** ${{ env.PROJECT_NAME }}\n**Tag:** ${{ gitea.ref_name }}\n**Version:** $VERSION\n**Auteur:** ${{ gitea.actor }}\n**Commit:** ${{ gitea.sha }}"
                else
                  TITLE="Push sur la branche"
                  COLOR="3447003"
                  EMOJI="üìù"
                  DESCRIPTION="**Projet:** ${{ env.PROJECT_NAME }}\n**Branche:** ${{ gitea.ref_name }}\n**Auteur:** ${{ gitea.actor }}\n**Commit:** ${{ gitea.sha }}\n**Message:** ${{ gitea.head_commit.message }}"
                fi
                ;;
              "pull_request")
                case "${{ gitea.event.action }}" in
                  "opened")
                    TITLE="Nouvelle Pull Request"
                    COLOR="3447003"
                    EMOJI="üîÄ"
                    ;;
                  "synchronize")
                    TITLE="Pull Request mise √† jour"
                    COLOR="15844367"
                    EMOJI="üîÑ"
                    ;;
                  "reopened")
                    TITLE="Pull Request r√©ouverte"
                    COLOR="15844367"
                    EMOJI="üîÑ"
                    ;;
                  "closed")
                    if [ "${{ gitea.event.pull_request.merged }}" == "true" ]; then
                      TITLE="Pull Request fusionn√©e"
                      COLOR="3066993"
                      EMOJI="‚úÖ"
                    else
                      TITLE="Pull Request ferm√©e"
                      COLOR="15158332"
                      EMOJI="‚ùå"
                    fi
                    ;;
                esac
                DESCRIPTION="**Projet:** ${{ env.PROJECT_NAME }}\n**PR:** #${{ gitea.event.pull_request.number }} - ${{ gitea.event.pull_request.title }}\n**Auteur:** ${{ gitea.actor }}\n**Branche:** ${{ gitea.event.pull_request.head.ref }} ‚Üí ${{ gitea.event.pull_request.base.ref }}"
                ;;
              "issues")
                case "${{ gitea.event.action }}" in
                  "opened")
                    TITLE="Nouvelle issue"
                    COLOR="15158332"
                    EMOJI="üêõ"
                    ;;
                  "closed")
                    TITLE="Issue ferm√©e"
                    COLOR="3066993"
                    EMOJI="‚úÖ"
                    ;;
                  "reopened")
                    TITLE="Issue r√©ouverte"
                    COLOR="15844367"
                    EMOJI="üîÑ"
                    ;;
                esac
                DESCRIPTION="**Projet:** ${{ env.PROJECT_NAME }}\n**Issue:** #${{ gitea.event.issue.number }} - ${{ gitea.event.issue.title }}\n**Auteur:** ${{ gitea.actor }}\n**Labels:** ${{ join(gitea.event.issue.labels.*.name, ', ') }}"
                ;;
              "release")
                case "${{ gitea.event.action }}" in
                  "published")
                    TITLE="Nouvelle release publi√©e"
                    COLOR="3066993"
                    EMOJI="üöÄ"
                    ;;
                  "edited")
                    TITLE="Release modifi√©e"
                    COLOR="15844367"
                    EMOJI="‚úèÔ∏è"
                    ;;
                  "deleted")
                    TITLE="Release supprim√©e"
                    COLOR="15158332"
                    EMOJI="üóëÔ∏è"
                    ;;
                esac
                DESCRIPTION="**Projet:** ${{ env.PROJECT_NAME }}\n**Release:** ${{ gitea.event.release.tag_name }}\n**Titre:** ${{ gitea.event.release.name }}\n**Auteur:** ${{ gitea.actor }}"
                ;;
              *)
                TITLE="‚Ñπ√âv√©nement"
                COLOR="3447003"
                EMOJI="‚ÑπÔ∏è"
                DESCRIPTION="**Projet:** ${{ env.PROJECT_NAME }}\n**√âv√©nement:** $EVENT_TYPE\n**Auteur:** ${{ gitea.actor }}"
                ;;
            esac

            curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "'"$EMOJI $TITLE"'",
                "description": "'"$DESCRIPTION"'",
                "color": '"$COLOR"',
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'",
                "footer": {
                  "text": "BlueMap Banner Point"
                }
              }]
            }'
          fi
